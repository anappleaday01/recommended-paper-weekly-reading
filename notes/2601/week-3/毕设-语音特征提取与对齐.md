### åˆ›å»ºè™šæ‹Ÿç¯å¢ƒ
source /Users/lounge/Desktop/undergraduate/audio_env/bin/activate
source ~/miniforge3/bin/activate ç¯å¢ƒå
#### è™šæ‹Ÿç¯å¢ƒï¼š
audio_env
asr
aligner

### å¯¹é½
[MFAæŒ‡å—](https://montreal-forced-aligner.readthedocs.io/en/latest/first_steps/index.html)
æŸ¥çœ‹å­—å…¸
/Users/lounge/Documents/MFA/CMDC/missing_transcriptions.csv

æ­¥éª¤è®°å½•
daic
```
mfa validate ~/Desktop/undergraduate/daic_alignment_data/prosodylab_corpus_directory en en

mfa align ~/Desktop/undergraduate/daic_alignment_data/prosodylab_corpus_directory english_us_arpa english_us_arpaÂ  ~/Desktop/undergraduate/daic_alignment_data/daic_aligned
```
![[æˆªå±2026-01-20 09.03.00.png]]

![[æˆªå±2026-01-20 09.00.06.png]]
cmdc
```
mfa g2p \

Â  Â  mandarin_china_pinyin_mfa \

Â  Â  ~/Downloads/CMDC ~/Desktop/undergraduate/CMDCâ€”â€”alignment_data
Â  Â  
mfa validate \

Â  Â  ~/Downloads/CMDC \ Â 

Â  Â  zh \

Â  Â  zh \Â  Â  Â  Â  Â  Â 

Â  Â  ~/Desktop/undergraduate/CMDC_alignment_data/cmdc_align_report \

Â  Â  --clean \

Â  Â  -v
Â  Â  
mfa align \

Â  Â  ~/Downloads/CMDC \

Â  Â  mandarin_mfa \

Â  Â  mandarin_mfa \

Â  Â  ~/Desktop/undergraduate/CMDC_alignment_data/cmdc_aligned
```
![[æˆªå±2026-01-20 09.02.28.png]]

![[æˆªå±2026-01-20 09.02.34.png]]

![[æˆªå±2026-01-20 09.02.40.png]]
#### æ­¥éª¤
# MFAï¼ˆMontreal Forced Alignerï¼‰å®Œæ•´å·¥ä½œæµç¨‹æ€»ç»“

## ğŸ“‹ ä¸€ã€æ ¸å¿ƒæ¦‚å¿µ
**MFAæ˜¯ä»€ä¹ˆ**ï¼šè‡ªåŠ¨è¯­éŸ³-æ–‡æœ¬å¯¹é½å·¥å…·ï¼Œä¸ºéŸ³é¢‘ä¸­çš„æ¯ä¸ªéŸ³ç´ /å•è¯æ ‡æ³¨æ—¶é—´è¾¹ç•Œï¼Œç”ŸæˆTextGridæ–‡ä»¶ã€‚

**åœ¨æŠ‘éƒç—‡è¯­éŸ³åˆ†æä¸­çš„ä½œç”¨**ï¼š
- æå–**éŸ³ç´ æ—¶é•¿**ã€**åœé¡¿æ¨¡å¼**ã€**è¯­é€Ÿå˜åŒ–**ç­‰å£°å­¦ç‰¹å¾
- è¿™äº›ç‰¹å¾ä¸æŠ‘éƒç—‡çš„è¯­éŸ³è¡¨ç°ï¼ˆè¯­é€Ÿæ…¢ã€åœé¡¿å¤šã€éŸ³ç´ æ—¶é•¿å˜å¼‚å¤§ï¼‰å¯†åˆ‡ç›¸å…³

---

## ğŸ”„ äºŒã€å®Œæ•´å·¥ä½œæµç¨‹ï¼ˆå…­æ­¥æ³•ï¼‰

### æ­¥éª¤1ï¼šç¯å¢ƒå‡†å¤‡
```bash
# 1. åˆ›å»ºcondaç¯å¢ƒ
conda create -n aligner python=3.8
conda activate aligner

# 2. å®‰è£…MFA
pip install montreal-forced-aligner

# 3. ä¸‹è½½ç¬¬ä¸‰æ–¹å·¥å…·å’Œæ¨¡å‹
mfa thirdparty download
mfa model download acoustic english
mfa model download dictionary english
```

### æ­¥éª¤2ï¼šæ•°æ®å‡†å¤‡ï¼ˆæœ€å…³é”®ï¼ï¼‰
**æ­£ç¡®çš„ç›®å½•ç»“æ„**ï¼š
```
corpus_directory/
â”œâ”€â”€ speaker001/
â”‚   â”œâ”€â”€ utterance1.wav
â”‚   â”œâ”€â”€ utterance1.lab    # å¯¹åº”æ–‡æœ¬ï¼š"hello world"
â”‚   â”œâ”€â”€ utterance2.wav
â”‚   â””â”€â”€ utterance2.lab
â””â”€â”€ speaker002/
    â””â”€â”€ ...
```

**éŸ³é¢‘æ ¼å¼è¦æ±‚**ï¼š
- æ ¼å¼ï¼šWAV
- é‡‡æ ·ç‡ï¼š16000 Hz
- ä½æ·±åº¦ï¼š16-bit
- å£°é“ï¼šå•å£°é“ï¼ˆmonoï¼‰

**è½¬å½•æ–‡ä»¶è¦æ±‚**ï¼š
- æ‰©å±•åï¼š`.lab`
- å†…å®¹ï¼šçº¯æ–‡æœ¬ï¼Œä¸€è¡Œå¯¹åº”ä¸€ä¸ªéŸ³é¢‘
- ç¼–ç ï¼šUTF-8

### æ­¥éª¤3ï¼šæ•°æ®éªŒè¯
```bash
mfa validate \
    /path/to/corpus_directory \
    english \
    english \
    /path/to/validation_output \
    --clean \
    -v
```

**æ£€æŸ¥éªŒè¯ç»“æœ**ï¼š
```bash
# æŸ¥çœ‹å…³é”®æ–‡ä»¶
cat /path/to/validation_output/corpus_stats.json
cat /path/to/validation_output/missing_transcriptions.csv
cat /path/to/validation_output/oovs_found.txt
```


**å¸¸è§é—®é¢˜åŠä¿®å¤**ï¼š

| é—®é¢˜ | è§£å†³æ–¹æ¡ˆ |
|------|----------|
| ç¼ºå°‘.labæ–‡ä»¶ | ä¸ºæ¯ä¸ª.wavåˆ›å»ºå¯¹åº”çš„.labæ–‡ä»¶ |
| éŸ³é¢‘æ ¼å¼ä¸å¯¹ | ç”¨soxè½¬æ¢ï¼š`sox input.wav -r 16000 -b 16 output.wav` |
| OOVå•è¯ | æ·»åŠ åˆ°è‡ªå®šä¹‰å­—å…¸ |


### æ­¥éª¤4ï¼šè¿è¡Œå¯¹é½
```bash
mfa align \
    /path/to/corpus_directory \
    english \
    english \
    /path/to/output_directory \
    --clean \
    --beam 200 \           # æŠ‘éƒç—‡è¯­éŸ³å»ºè®®å¢å¤§beam
    --retry_beam 600 \     # å› è¯­é€Ÿæ…¢ã€åœé¡¿å¤š
    --num_jobs 4 \         # æ ¹æ®CPUæ ¸å¿ƒæ•°è°ƒæ•´
    --frame_shift 10 \     # æ ‡å‡†å‚æ•°
    --frame_length 25 \    # æ ‡å‡†å‚æ•°
    -v 2>&1 | tee align_log.txt
```
âœ¨
```
mfa align ~/Desktop/undergraduate/daic_alignment_data/prosodylab_corpus_directory english_us_arpa(å­—å…¸) english_us_arpaï¼ˆæ¨¡å‹ï¼‰Â  ~/Desktop/undergraduate/daic_alignment_data/daic_aligned
```
### æ­¥éª¤5ï¼šæ£€æŸ¥å¯¹é½ç»“æœ
```bash
# æ£€æŸ¥è¾“å‡º
ls -la /path/to/output_directory/

# æŸ¥çœ‹ç”Ÿæˆçš„TextGridæ–‡ä»¶æ•°
find /path/to/output_directory -name "*.TextGrid" | wc -l

# é¢„è§ˆä¸€ä¸ªTextGridæ–‡ä»¶
head -20 /path/to/output_directory/speaker001/utterance1.TextGrid
```

### æ­¥éª¤6ï¼šæå–æŠ‘éƒç—‡ç›¸å…³ç‰¹å¾
```python
from praatio import tgio
import numpy as np

def extract_depression_features(textgrid_path):
    tg = tgio.openTextgrid(textgrid_path)
    phone_tier = tg.tierDict["phones"]
    
    # æå–å…³é”®ç‰¹å¾
    features = {
        'total_duration': phone_tier[-1].end,
        'pause_ratio': len([p for p in phone_tier if p.label in ['sp', 'sil']]) / len(phone_tier),
        'mean_phone_duration': np.mean([p.end-p.start for p in phone_tier if p.label not in ['sp', 'sil']]),
        'speech_rate': len([p for p in phone_tier if p.label not in ['sp', 'sil']]) / phone_tier[-1].end,
        'phone_duration_std': np.std([p.end-p.start for p in phone_tier if p.label not in ['sp', 'sil']]),
    }
    return features
```

---

## âš ï¸ ä¸‰ã€å¸¸è§é”™è¯¯åŠè§£å†³æ–¹æ¡ˆ

### é”™è¯¯1ï¼šæ‰¾ä¸åˆ°æ¨¡å‹æ–‡ä»¶
```bash
# ç—‡çŠ¶ï¼šCould not find final.mdl in ...
# è§£å†³ï¼š
cd ~/Documents/MFA/extracted_models/acoustic/en_acoustic
ln -s English/* .  # åˆ›å»ºç¬¦å·é“¾æ¥
```


## ğŸ¯ å››ã€æŠ‘éƒç—‡è¯­éŸ³åˆ†æä¼˜åŒ–å»ºè®®

### 1. **å‚æ•°è°ƒæ•´**
```bash
# æŠ‘éƒç—‡è¯­éŸ³ä¸“ç”¨å‚æ•°
mfa align ... \
    --beam 200 \           # å¢å¤§beamå€¼ï¼Œé€‚åº”è¯­é€Ÿå˜åŒ–
    --retry_beam 600 \     # å¢å¤§é‡è¯•beam
    --uses_speaker_adaptation true \  # ä½¿ç”¨è¯´è¯äººè‡ªé€‚åº”
    --uses_phone_models true \        # ä½¿ç”¨éŸ³ç´ æ¨¡å‹
```

### 2. **ç‰¹å¾æå–é‡ç‚¹**
| ç‰¹å¾ç±»å‹ | æŠ‘éƒç—‡å…³è” | æå–æ–¹æ³• |
|----------|------------|----------|
| éŸ³ç´ æ—¶é•¿ | è¯­é€Ÿæ…¢ï¼Œå‘éŸ³å»¶é•¿ | è®¡ç®—éæš‚åœéŸ³ç´ å¹³å‡æ—¶é•¿ |
| åœé¡¿æ¨¡å¼ | åœé¡¿å¤šä¸”ä¸è§„åˆ™ | ç»Ÿè®¡sp/siléŸ³ç´ æ¯”ä¾‹ |
| è¯­é€Ÿå˜åŒ– | è¯­é€Ÿä¸ç¨³å®š | è®¡ç®—éŸ³ç´ æ—¶é•¿çš„æ ‡å‡†å·® |
| éŸµå¾‹ç‰¹å¾ | è¯­è°ƒå¹³å¦ | éœ€ç»“åˆåŸºé¢‘åˆ†æ |

### 3. **è´¨é‡æ§åˆ¶**
```python
# æ£€æŸ¥å¯¹é½è´¨é‡
def check_alignment_quality(textgrid_path, min_confidence=0.5):
    tg = tgio.openTextgrid(textgrid_path)
    
    # æ£€æŸ¥éŸ³ç´ æ•°é‡
    num_phones = len(tg.tierDict["phones"])
    
    # æ£€æŸ¥æ˜¯å¦æœ‰å¼‚å¸¸çŸ­çš„éŸ³ç´ ï¼ˆå¯¹é½é”™è¯¯æ ‡å¿—ï¼‰
    phone_durations = [p.end-p.start for p in tg.tierDict["phones"]]
    short_phones = sum(1 for d in phone_durations if d < 0.01)
    
    return {
        'num_phones': num_phones,
        'short_phone_ratio': short_phones/num_phones if num_phones>0 else 0,
        'quality_flag': short_phones/num_phones < 0.1 if num_phones>0 else False
    }
```

---

## ğŸ“Š äº”ã€ä¸æŠ‘éƒç—‡ç ”ç©¶ pipeline é›†æˆ

```
åŸå§‹éŸ³é¢‘ â†’ MFAå¯¹é½ â†’ TextGridæ–‡ä»¶ â†’ ç‰¹å¾æå– â†’ æœºå™¨å­¦ä¹ æ¨¡å‹ â†’ æŠ‘éƒç—‡è¯„ä¼°
    â†“           â†“           â†“           â†“           â†“           â†“
  DAIC-WOZ   éŸ³ç´ è¾¹ç•Œ   æ—¶é•¿/åœé¡¿   éŸµå¾‹ç‰¹å¾   åˆ†ç±»/å›å½’   PHQ-9åˆ†æ•°
  MODMA      å•è¯è¾¹ç•Œ   è¯­é€Ÿç‰¹å¾   éŸ³è´¨ç‰¹å¾   æ·±åº¦å­¦ä¹    HAMDè¯„åˆ†
```

### ç‰¹å¾æå–ç¤ºä¾‹ï¼š
```python
def extract_all_depression_features(aligned_dir):
    """ä»å¯¹é½ç»“æœæå–å®Œæ•´ç‰¹å¾é›†"""
    features_list = []
    
    for textgrid_file in Path(aligned_dir).rglob("*.TextGrid"):
        # åŸºç¡€ç‰¹å¾
        base_feats = extract_depression_features(textgrid_file)
        
        # é«˜çº§ç‰¹å¾
        advanced_feats = {
            'articulation_rate': base_feats['speech_rate'] / (1 - base_feats['pause_ratio']),
            'pause_frequency': base_feats['pause_ratio'] * 60,  # æ¯åˆ†é’Ÿåœé¡¿æ¬¡æ•°
            'duration_variability': base_feats['phone_duration_std'] / base_feats['mean_phone_duration'],
        }
        
        features_list.append({**base_feats, **advanced_feats})
    
    return pd.DataFrame(features_list)
```

## ğŸ“ˆ ä¸ƒã€é¢„æœŸç»“æœä¸è¯„ä¼°

### æˆåŠŸæ ‡å¿—ï¼š
1. âœ… æ¯ä¸ªéŸ³é¢‘ç”Ÿæˆå¯¹åº”çš„TextGridæ–‡ä»¶
2. âœ… TextGridåŒ…å«`phones`å’Œ`words`ä¸¤ä¸ªå±‚çº§
3. âœ… éŸ³ç´ è¾¹ç•Œåˆç†ï¼ˆæ— å¼‚å¸¸çŸ­çš„éŸ³ç´ ï¼‰
4. âœ… ç‰¹å¾æå–æˆåŠŸè·å¾—æ•°å€¼çŸ©é˜µ

### è´¨é‡æ£€æŸ¥ï¼š
```bash
# ç»Ÿè®¡å¯¹é½æˆåŠŸç‡
python -c "
from pathlib import Path
textgrids = list(Path('output').rglob('*.TextGrid'))
audios = list(Path('corpus').rglob('*.wav'))
print(f'å¯¹é½æˆåŠŸç‡: {len(textgrids)/len(audios)*100:.1f}%')
"
```

---

## ğŸ”— å…«ã€åç»­æ­¥éª¤

MFAå¯¹é½å®Œæˆåï¼Œç»§ç»­æŠ‘éƒç—‡åˆ†æï¼š

1. **ç‰¹å¾å·¥ç¨‹**ï¼šä»TextGridæå–æ›´å¤šå£°å­¦ç‰¹å¾
2. **æ•°æ®æ ‡æ³¨**ï¼šç»“åˆPHQ-9/HAMDåˆ†æ•°
3. **æ¨¡å‹è®­ç»ƒ**ï¼šä½¿ç”¨æå–çš„ç‰¹å¾è®­ç»ƒæŠ‘éƒç—‡åˆ†ç±»å™¨
4. **ç»“æœåˆ†æ**ï¼šéªŒè¯è¯­éŸ³ç‰¹å¾ä¸æŠ‘éƒä¸¥é‡åº¦çš„ç›¸å…³æ€§

---

## ğŸ“ æ€»ç»“è¦ç‚¹

| æ­¥éª¤ | å‘½ä»¤/æ“ä½œ | å…³é”®æ£€æŸ¥ç‚¹ |
|------|-----------|------------|
| 1. ç¯å¢ƒå‡†å¤‡ | `mfa model download` | æ¨¡å‹æ–‡ä»¶å­˜åœ¨ |
| 2. æ•°æ®å‡†å¤‡ | ç»„ç»‡ç›®å½•ç»“æ„ | .wavå’Œ.labæ–‡ä»¶é…å¯¹ |
| 3. æ•°æ®éªŒè¯ | `mfa validate` | æ— ERRORï¼ŒOOVå¯æ§ |
| 4. è¿è¡Œå¯¹é½ | `mfa align` | ç”ŸæˆTextGridæ–‡ä»¶ |
| 5. æ£€æŸ¥ç»“æœ | æŸ¥çœ‹TextGrid | éŸ³ç´ è¾¹ç•Œåˆç† |
| 6. ç‰¹å¾æå– | Pythonè„šæœ¬ | è·å¾—ç‰¹å¾çŸ©é˜µ |

**é»„é‡‘æ³•åˆ™**ï¼šæ€»æ˜¯å…ˆ`validate`å†`align`ï¼Œç¡®ä¿æ•°æ®æ ¼å¼æ­£ç¡®å†å¼€å§‹è€—æ—¶çš„å¯¹é½è¿‡ç¨‹ã€‚

**æŠ‘éƒç—‡ç ”ç©¶ç‰¹åˆ«æç¤º**ï¼šMFAå¯¹é½çš„è´¨é‡ç›´æ¥å½±å“åç»­ç‰¹å¾æå–çš„å¯é æ€§ï¼ŒåŠ¡å¿…æ£€æŸ¥å¯¹é½ç»“æœï¼Œç‰¹åˆ«æ˜¯å¯¹äºè¯­é€Ÿæ…¢ã€åœé¡¿å¤šçš„æŠ‘éƒç—‡è¯­éŸ³ã€‚
### å‚è€ƒèµ„æ–™
[BFAä¸æ”¯æŒä¸­æ–‡](https://github.com/tabahi/bournemouth-forced-aligner)
[è¯­éŸ³ç¼–è¾‘](https://www.microsoft.com/en-us/research/articles/text-based-speech-editing/)